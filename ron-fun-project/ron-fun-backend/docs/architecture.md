# Ron.fun 系统架构设计

本文档描述 Ron.fun 项目的系统架构设计，包括技术栈选择、模块划分和数据流设计。

## 技术栈

### 后端技术栈
- **语言**: Python 3.12
- **Web框架**: FastAPI
- **ORM**: SQLAlchemy
- **数据库**: MySQL 8.0
- **身份验证**: JWT (JSON Web Token)
- **依赖管理**: uv 和 pip
- **API文档**: OpenAPI (Swagger UI)
- **测试框架**: pytest

### 前端技术栈
- **框架**: Vue.js 3 + Vite (H5客户端), React 18 (管理后台)
- **UI库**: Vant (H5客户端), Ant Design (管理后台)
- **状态管理**: Pinia (H5客户端), Redux Toolkit (管理后台)
- **路由**: Vue Router, React Router
- **HTTP客户端**: Axios

### 部署与运维
- **容器化**: Docker
- **编排**: Docker Compose
- **反向代理**: Nginx
- **CI/CD**: GitLab CI/CD
- **监控**: Prometheus + Grafana

## 系统架构

```
                                  ┌───────────────┐
                                  │  负载均衡器   │
                                  └───────┬───────┘
                                          │
         ┌─────────────────────────────────────────────────────┐
         │                                                     │
┌────────▼─────────┐                              ┌────────────▼─────┐
│  H5客户端前端    │                              │  管理后台前端    │
│  (Nginx + Vue)   │                              │  (Nginx + React) │
└────────┬─────────┘                              └────────────┬─────┘
         │                                                     │
┌────────▼─────────────────────────────────────────────────────▼─────┐
│                            API网关层 (Nginx)                        │
└────────────────────────────────┬──────────────────────────────────┘
                                 │
                  ┌──────────────▼─────────────────┐
                  │       API服务层 (FastAPI)      │
                  └──────────────┬─────────────────┘
                                 │
         ┌─────────────────────────────────────────────────────┐
         │                                                     │
┌────────▼─────────┐                              ┌────────────▼─────┐
│   业务逻辑层     │                              │    存储层        │
│   (Services)     │                              │  (MySQL + S3)    │
└──────────────────┘                              └──────────────────┘
```

## 模块设计

### 核心模块

1. **用户模块**
   - 用户注册与登录
   - 权限管理
   - 用户信息管理

2. **积分模块**
   - 积分明细记录
   - 积分规则管理
   - 积分变更事务处理

3. **抽奖模块**
   - 抽奖活动管理
   - 奖品管理
   - 抽奖记录

4. **商品模块**
   - 商品分类管理
   - 商品信息管理
   - 库存管理

5. **订单模块**
   - 订单创建与管理
   - 积分兑换处理
   - 订单状态流转

6. **内容管理模块**
   - Banner管理
   - 应用列表管理
   - 内容统计与分析

### 公共模块

1. **认证与授权**
   - JWT令牌生成与验证
   - 权限控制中间件
   - 角色管理

2. **数据访问层**
   - 数据库会话管理
   - CRUD基础操作封装
   - 查询优化与缓存

3. **文件管理**
   - 文件上传处理
   - 图片处理与压缩
   - 存储服务集成

4. **通用工具**
   - 日志记录
   - 错误处理
   - 数据验证

## 数据库设计

### 主要实体关系

```
User ──┬── PointLog
       ├── LotteryRecord
       ├── Order
       ├── Address
       ├── BannerClick
       └── ApplicationClick

Product ──┬── ProductCategory
          └── Order

LotteryActivity ──┬── LotteryType
                  └── LotteryRecord

Banner ── BannerClick

Application ── ApplicationClick
```

### 核心表结构

- **用户相关**: user, point_log, address
- **商品相关**: product, product_category, order
- **抽奖相关**: lottery_activity, lottery_type, lottery_record
- **内容相关**: banner, banner_click, application, application_click

## 接口设计

采用RESTful API设计风格，主要接口路径：

- **/api/v1/auth**: 认证相关接口
- **/api/v1/users**: 用户相关接口
- **/api/v1/products**: 商品相关接口
- **/api/v1/lottery**: 抽奖相关接口
- **/api/v1/orders**: 订单相关接口
- **/api/v1/banners**: Banner相关接口
- **/api/v1/applications**: 应用相关接口
- **/api/v1/admin/**: 管理后台相关接口

## 安全设计

1. **身份验证**
   - 基于JWT的认证机制
   - 令牌定期轮换
   - 敏感操作二次验证

2. **数据安全**
   - 密码哈希存储(bcrypt)
   - 敏感数据加密
   - SQL注入防护

3. **访问控制**
   - 基于角色的权限控制
   - API访问速率限制
   - 请求来源验证

## 扩展性设计

1. **水平扩展**
   - 无状态API服务设计
   - 数据库读写分离

2. **模块化**
   - 松耦合服务设计
   - 清晰的服务边界

3. **版本控制**
   - API版本管理
   - 数据库迁移管理 